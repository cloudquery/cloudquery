---
title: How to Manage AWS Resource and Usage Limits with CloudQuery and Service Quotas
tag: tutorial
description: >-
  Cloud Usage
author: jsonkao
---

import { HowToGuideHeader } from "../../components/HowToGuideHeader"

<HowToGuideHeader/>

## Introduction

AWS Accounts come with over 200 services and each service has different types of resources.  Benefits of cloud computing include the ease of use, elasticity, and advantages of using these cloud services.  However, cloud services come with usage and resource limits.  Proper management of these usage and resource limits can prevent against availability issues when a resource cannot be created, a service is throttled, and helps with proactive management and troubleshooting of limit constraints that may impact active production applications and development environments. 

In 2019, [AWS introduced Service Quotas](https://aws.amazon.com/blogs/mt/introducing-service-quotas-view-and-manage-your-quotas-for-aws-services-from-one-central-location/), a new service to help with managing these limits (now called quotas) from a central location.

For companies managing multiple AWS accounts, 

In this guide, we'll show how to use open source CloudQuery to augment existing capabilities from Amazon Web Services with additional data to better manage and monitor service limits in AWS.

### Example Limit Scenarios

Example scenarios we've seen where resource management (as of June 2023):

* Reaching the maximum number of S3 buckets in an account.  The default limit of S3 buckets in an account is 100.

* Reaching the maximum number of Lambda network interfaces.  The default limit of network interfaces that Lambda creates for a VPC with functions attached is 250.  Lambda creates a network interface for each combination of function subnets and seurity groups.

* Reaching KMS Key API Limits.  KMS has API Limits that are adjustable such as CreateAlias and CreateKey request rates which by default are set to 5 per second.  Some applications and enterprise architectures may require higher request rates.

* Reaching CloudFormation Stack Limits.  Accounts by default have a default limit of 2000 Stacks.  For teams with heavy infrastructure as code practices and in accounts with heavy infrastructure, teams could reach the maximum number of stacks. 

* Reaching Identity and Access limits including managed policies per role.  By default, roles can have a maximum number of 10 attached managed policies.  For teams that use many managed policies to attach custom permissions to IAM principals, they may reach the limit of 10 managed policies and be unable to attach more policies or have failed attachments.

Other limits include EC2 with spot instances, networking, number of running dedicated hosts.


## Managing Service Quotas

https://www.cloudquery.io/docs/plugins/sources/aws/tables/aws_servicequotas_quotas

One option provided by AWS is to utilize AWS Trusted Advisor (and AWS Support).  [AWS Trusted Advisor](https://aws.amazon.com/premiumsupport/technology/trusted-advisor/) offers checks for service quotas with AWS Basic Support and AWS Developer Support Plans.  AWS Business and Enterprise Support customers get all checks which include service quota checks.  However, Trusted Advisor currently (as of June 2023) only supports 51 checks.  Additionally, programmatic access to Trusted Advisor APIs (and Support) requires either a Business, Enterprise On-Ramp, or Enterprise Support Plan with AWS.

![Trusted Advisor Console](/images/how-to-guides/aws-resource-limits-and-service-quotas/trusted-advisor.png)

Another option is to integrate AWS Service Quotas with CloudWatch for alerting.  However, these integrations only [work with Service Quotas that support CloudWatch Alarms](https://docs.aws.amazon.com/servicequotas/latest/userguide/configure-cloudwatch.html).

With CloudQuery, we'll demonstrate another option: how to use CloudQuery to manage and monitor resource utilization and service quota usage.  We'll also use CloudQuery to sync information from Trusted Advisor and Support

## Walkthrough

We'll focus on the following tables and services:
* [AWS Service Quotas Quotas](https://www.cloudquery.io/docs/plugins/sources/aws/tables/aws_servicequotas_quotas)
* [AWS Trusted Advisor Checks](https://www.cloudquery.io/docs/plugins/sources/aws/tables/aws_support_trusted_advisor_checks)
* [AWS Trusted Advisor Check Results](https://www.cloudquery.io/docs/plugins/sources/aws/tables/aws_support_trusted_advisor_check_results)
* [AWS Support Cases](https://www.cloudquery.io/docs/plugins/sources/aws/tables/aws_support_cases) 

To start with the sync, check out the [AWS Configuration Guide](https://www.cloudquery.io/docs/plugins/sources/aws/configuration).  We'll start with the following `aws.yml` source configuration file.

```
kind: source
spec:
  # Source spec section
  name: aws
  path: cloudquery/aws
  version: "VERSION_SOURCE_AWS"
  tables: 
    - aws_servicequotas_services
    - aws_support_trusted_advisor_checks
    - aws_support_cases
  destinations: ["DESTINATION_NAME"]
  spec: 
    # AWS Spec section described below
    regions: 
      - us-east-1
    accounts:
      - id: "account1"
        local_profile: "account1"
    aws_debug: false
```


### Reference Queries

We will first look for all Service Quotas that are adjustable.  Service Quotas can either be a hard limit (non-adjustable) or a soft limit (adjustable).

```sql copy
SELECT * FROM aws_servicequotas_quotas
WHERE adjustable = TRUE;
```



```sql copy
SELECT * FROM aws_support_trusted_advisor_checks
WHERE category='service_limits';
```


Now let's check our S3 service limits and augment that with statistics on our S3 usage.

```sql copy

```


We can repeat that for other use cases as well

```sql copy

```


Now, we can look for more complex use cases such as API limits.  For this query, we'll need to sync `aws_cloudtrail_events` as a resource from AWS.  This resource can take time to sync due to the sheer amount of data in `aws_cloudtrail_events`.

```sql copy

```


## Summary


## References

[CloudQuery: AWS Source Plugin](/docs/plugins/sources/aws/overview)

