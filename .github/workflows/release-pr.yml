name: release-please-monorepo
on:
  push:
    branches:
      - monorepo

jobs:
  release-pr-monorepo:
    runs-on: ubuntu-latest
    outputs:
      releases: ${{ toJSON(steps.release.outputs) }}
    steps:
      - uses: google-github-actions/release-please-action@v3
        id: release
        with:
          command: manifest
          token: ${{ secrets.GH_CQ_BOT }}
          default-branch: monorepo
  mark-prerelease-monorepo:
    needs: [release-pr-monorepo]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        release:
          - cli
          - plugins/aws
          - plugins/azure
          - plugins/cloudflare
          - plugins/digitalocean
          - plugins/fuzz
          - plugins/gcp
          - plugins/github
          - plugins/k8s
          - plugins/okta
          - plugins/terraform
    steps:
      # We mark all releases as pre-release until we finish building & uploading the binaries
      # GoReleaser will upload the binaries to GitHub and mark the release as ready
      - name: Mark as pre-release
        if: ${{ needs.release-please.outputs.releases['${{ matrix.release }}--release_created'] }}
        uses: tubone24/update_release@2146f1550a23d883b8ea0c036298ed74cd65eac6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ steps.release.outputs.releases['${{ matrix.release }}--tag_name'] }}
        with:
          prerelease: true
