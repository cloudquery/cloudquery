name: Check for broken links

on:
  pull_request:
    paths:
      - "website/**"

jobs:
  check-broken-links:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "lts/*"

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v26
        with:
          files: |
            website
            plugins/**/docs/**

      - name: Waiting for Vercel Preview
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: patrickedqvist/wait-for-vercel-preview@v1.2.0
        id: vercel-deployment
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: "Preview – cloudquery-web"
          max_timeout: 360
          check_interval: 10

      - name: Check for broken links
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          set -o pipefail

          npx broken-link-checker --requests 20 --host-requests 1 -f -r -v -o --filter-level 3 \
            --exclude linkedin \
            --exclude cloudquery.io/discord \
            --exclude cloudquery.io/assets/aws_security_group_view.sql \
            --exclude https://www.cloudquery.io/logo \
            --exclude fonts.gstatic.com \
            --exclude fonts.googleapis.com \
            --exclude twitter.com \
            --exclude support.google.com \
            --exclude work-bench.com \
            --exclude podcasts.apple.com \
            --exclude docs.cloudquery.io/cdn-cgi/l/email-protection \
            --exclude pcisecuritystandards.org \
            ${{ steps.vercel-deployment.outputs.url }} \
            | grep -v '───OK───' | grep -v '──SKIP──'
