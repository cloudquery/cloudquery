name: Unit Tests CLI

on:
  pull_request:
    branches:
      - main
env:
  CGO_ENABLED: 0

jobs:
  check-cli-changes:
    name: Check for CLI Changes
    runs-on: ubuntu-latest
    outputs:
      cli-changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v28
        with:
          files: |
            cli
            .github/workflows/test_cli.yml
          files_ignore: |
            cli/CHANGELOG.md
  test-unit:
    name: Cross Env Unit Tests
    needs: [check-cli-changes]
    if: needs.check-cli-changes.outputs.cli-changed == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
        workdir: [cli]
        postgres: ['11']
      fail-fast: false
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      - name: Set up Go 1.x
        uses: actions/setup-go@v3
        with:
          go-version: 1.19.1
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-1.19.1-${{ hashFiles(format('{0}/go.sum', matrix.workdir)) }}
          restore-keys: |
            ${{ runner.os }}-go-1.19.1-${{ matrix.workdir }}
      - name: Get dependencies
        working-directory: ${{ matrix.workdir }}
        run: go get -v -t -d ./...
      - uses: docker-practice/actions-setup-docker@50400dd6e7c92d4a9f5a3cb9162b21e8a041aeec
        if: matrix.os != 'windows-latest'
      - name: Test
        run: |
          docker run -p 5432:5432 -e POSTGRES_PASSWORD=pass -d postgres:${{ matrix.postgres }}
          go build
          go test -v ./...
        working-directory: ${{ matrix.workdir }}