WITH malware_agent_installed_vm AS (
    SELECT DISTINCT
        virtual_machine_cq_id
    FROM
        azure_compute_virtual_machine_resources
    WHERE
        publisher = 'Microsoft.Azure.Security'
        AND extension_type = 'IaaSAntimalware'
)
insert into azure_policy_results
SELECT
  :'execution_time',
  :'framework',
  :'check_id',
  'Deploy default Microsoft IaaSAntimalware extension for Windows Server',
  azure_compute_virtual_machines.vm_id,
  azure_subscription_subscriptions.subscription_id,
  case
    when azure_subscription_subscriptions.subscription_id = azure_compute_virtual_machines.subscription_id
	    AND malware_agent_installed_vm.virtual_machine_cq_id IS NULL
    then 'fail' else 'pass'
  end
FROM
	azure_compute_virtual_machines
	LEFT JOIN malware_agent_installed_vm ON malware_agent_installed_vm.virtual_machine_cq_id = azure_compute_virtual_machines.cq_id,
	azure_subscription_subscriptions