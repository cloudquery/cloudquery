WITH safe_dbs AS (
    SELECT s.sql_database_id
    FROM azure_sql_database_vulnerability_assessment_scans s
             JOIN
         (
             SELECT _cq_id, MAX(end_time) AS max_dt
             FROM azure_sql_database_vulnerability_assessment_scans
             GROUP BY _cq_id
         ) t ON s._cq_id = t._cq_id AND s.end_time = t.max_dt
    WHERE s.number_of_failed_security_checks = 0)
insert into azure_policy_results
SELECT
  :'execution_time' as execution_time,
  :'framework' as framework,
  :'check_id' as check_id,
  'SQL databases should have vulnerability findings resolved' as title,
  subscription_id,
  id,
  case
    when id IS NULL
      then 'fail' else 'pass'
  end
FROM azure_sql_databases d
         LEFT JOIN safe_dbs sd ON d.id = sd.sql_database_id;